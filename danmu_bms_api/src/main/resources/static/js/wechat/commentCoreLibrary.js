function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(t){for(var e=0;e<this.modifiers.length;e++)t=this.modifiers[e](t);return t},this.beforeSend=function(t){return t},this.doValidate=function(t){return this.allowTypes[t.mode]?!0:!1},this.addRule=function(){},this.addModifier=function(t){this.modifiers.push(t)},this.runtimeFilter=function(t){return null==this.runtime?t:this.runtime(t)},this.setRuntimeFilter=function(t){this.runtime=t}}function AcfunParser(t){var e=[];try{var i=JSON.parse(t)}catch(o){return console.log("Error: Could not parse json list!"),[]}for(var s=0;s<i.length;s++){var n={},r=i[s].c.split(",");if(r.length>0){if(n.stime=1e3*parseFloat(r[0]),n.color=parseInt(r[1]),n.mode=parseInt(r[2]),n.dur=7e3,n.size=parseInt(r[3])>=35?20:parseInt(r[3]*0.68),n.hash=r[4],n.date=parseInt(r[5]),n.position="absolute",7!=n.mode?(n.text=i[s].m.replace(/(\/n|\\n|\n|\r\n|\\r)/g,"\n"),n.text=n.text.replace(/\r/g,"\n"),n.text=n.text.replace(/\s/g," ")):n.text=i[s].m,7==n.mode){try{var h=JSON.parse(n.text)}catch(o){console.log("[Err] Error parsing internal data for comment"),console.log("[Dbg] "+n.text);continue}if(n.position="relative",n.text=h.n,n.text=n.text.replace(/\ /g," "),n.opacity=null!=h.a?h.a:1,null!=h.p?(n.x=h.p.x/1e3,n.y=h.p.y/1e3):(n.x=0,n.y=0),n.shadow=h.b,n.dur=4e3,null!=h.l&&(n.moveDelay=1e3*h.l),null!=h.z&&h.z.length>0){n.movable=!0,n.motion=[];for(var a=0,l={x:n.x,y:n.y,alpha:n.opacity,color:n.color},p=0;p<h.z.length;p++){var d=null!=h.z[p].l?1e3*h.z[p].l:500;a+=d;var c={x:{from:l.x,to:h.z[p].x/1e3,dur:d,delay:0},y:{from:l.y,to:h.z[p].y/1e3,dur:d,delay:0}};l.x=c.x.to,l.y=c.y.to,h.z[p].t!==l.alpha&&(c.alpha={from:l.alpha,to:h.z[p].t,dur:d,delay:0},l.alpha=c.alpha.to),null!=h.z[p].c&&h.z[p].c!==l.color&&(c.color={from:l.color,to:h.z[p].c,dur:d,delay:0},l.color=c.color.to),n.motion.push(c)}n.dur=a+(n.moveDelay?n.moveDelay:0)}null!=h.r&&null!=h.k&&(n.rX=h.r,n.rY=h.k)}e.push(n)}}return e}function BilibiliParser(t,e,i){function o(t){return t.replace(/\t/,"\\t")}if(null!==t)var s=t.getElementsByTagName("d");else{if(!document||!document.createElement)return[];if(i){if(!confirm("XML Parse Error. \n Allow tag soup parsing?\n[WARNING: This is unsafe.]"))return[]}else e=e.replace(new RegExp("</([^d])","g"),"</disabled $1"),e=e.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),e=e.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),e=e.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1");var n=document.createElement("div");n.innerHTML=e;var s=n.getElementsByTagName("d")}for(var r=[],h=0;h<s.length;h++)if(null!=s[h].getAttribute("p")){var a=s[h].getAttribute("p").split(",");if(!s[h].childNodes[0])continue;var e=s[h].childNodes[0].nodeValue,l={};if(l.stime=Math.round(1e3*parseFloat(a[0])),l.size=parseInt(a[2]),l.color=parseInt(a[3]),l.mode=parseInt(a[1]),l.date=parseInt(a[4]),l.pool=parseInt(a[5]),l.position="absolute",null!=a[7]&&(l.dbid=parseInt(a[7])),l.hash=a[6],l.border=!1,l.mode<7)l.text=e.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==l.mode)try{if(adv=JSON.parse(o(e)),l.shadow=!0,l.x=parseFloat(adv[0]),l.y=parseFloat(adv[1]),(Math.floor(l.x)<l.x||Math.floor(l.y)<l.y)&&(l.position="relative"),l.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),l.rZ=0,l.rY=0,adv.length>=7&&(l.rZ=parseInt(adv[5],10),l.rY=parseInt(adv[6],10)),l.motion=[],l.movable=!1,adv.length>=11){l.movable=!0;var p=500,d={x:{from:l.x,to:parseFloat(adv[7]),dur:p,delay:0},y:{from:l.y,to:parseFloat(adv[8]),dur:p,delay:0}};if(""!==adv[9]&&(p=parseInt(adv[9],10),d.x.dur=p,d.y.dur=p),""!==adv[10]&&(d.x.delay=parseInt(adv[10],10),d.y.delay=parseInt(adv[10],10)),adv.length>11&&(l.shadow=adv[11],"true"===l.shadow&&(l.shadow=!0),"false"===l.shadow&&(l.shadow=!1),null!=adv[12]&&(l.font=adv[12]),adv.length>14)){"relative"===l.position&&(console.log("Cannot mix relative and absolute positioning"),l.position="absolute");for(var c=adv[14],u={x:d.x.from,y:d.y.from},m=[],f=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),y=c.split(/[a-zA-Z]/).length-1,g=f.exec(c);null!==g;){switch(g[1]){case"M":u.x=parseInt(g[2],10),u.y=parseInt(g[3],10);break;case"L":m.push({x:{from:u.x,to:parseInt(g[2],10),dur:p/y,delay:0},y:{from:u.y,to:parseInt(g[3],10),dur:p/y,delay:0}}),u.x=parseInt(g[2],10),u.y=parseInt(g[3],10)}g=f.exec(c)}d=null,l.motion=m}null!==d&&l.motion.push(d)}l.dur=2500,adv[3]<12&&(l.dur=1e3*adv[3]);var n=adv[2].split("-");if(null!=n&&n.length>1){var b=parseFloat(n[0]),_=parseFloat(n[1]);l.opacity=b,b!==_&&(l.alpha={from:b,to:_})}}catch(v){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+e)}else 8==l.mode&&(l.code=e);null!=l.text&&(l.text=l.text.replace(/\u25a0/g,"â–ˆ")),r.push(l)}return r}var BinArray=function(){var t={};return t.bsearch=function(t,e,i){if(0===t.length)return 0;if(i(e,t[0])<0)return 0;if(i(e,t[t.length-1])>=0)return t.length;for(var o=0,s=0,n=0,r=t.length-1;r>=o;){if(s=Math.floor((r+o+1)/2),n++,i(e,t[s-1])>=0&&i(e,t[s])<0)return s;i(e,t[s-1])<0?r=s-1:i(e,t[s])>=0?o=s:console.error("Program Error"),n>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(e,i,o){var s=t.bsearch(e,i,o);return e.splice(s,0,i),s},t}(),__extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);i.prototype=e.prototype,t.prototype=new i},CommentSpaceAllocator=function(){function t(t,e){"undefined"==typeof t&&(t=0),"undefined"==typeof e&&(e=0),this._pools=[[]],this.avoid=1,this._width=t,this._height=e}return t.prototype.willCollide=function(t,e){return t.stime+t.ttl>=e.stime+e.ttl/2},t.prototype.pathCheck=function(t,e,i){for(var o=t+e.height,s=e.right,n=0;n<i.length;n++)if(!(i[n].y>o||i[n].bottom<t)){if(!(i[n].right<e.x||i[n].x>s))return!1;if(this.willCollide(i[n],e))return!1}return!0},t.prototype.assign=function(t,e){for(;this._pools.length<=e;)this._pools.push([]);var i=this._pools[e];if(0===i.length)return t.cindex=e,0;if(this.pathCheck(0,t,i))return t.cindex=e,0;for(var o=0,s=0;s<i.length&&(o=i[s].bottom+this.avoid,!(o+t.height>this._height));s++)if(this.pathCheck(o,t,i))return t.cindex=e,o;return this.assign(t,e+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,e){return t.bottom<e.bottom?-1:t.bottom>e.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw new Error("cindex out of bounds");var e=this._pools[t.cindex].indexOf(t);0>e||this._pools[t.cindex].splice(e,1)}},t.prototype.setBounds=function(t,e){this._width=t,this._height=e},t}(),AnchorCommentSpaceAllocator=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.add=function(e){t.prototype.add.call(this,e),e.x=(this._width-e.width)/2},e.prototype.willCollide=function(){return!0},e.prototype.pathCheck=function(t,e,i){for(var o=t+e.height,s=0;s<i.length;s++)if(!(i[s].y>o||i[s].bottom<t))return!1;return!0},e}(CommentSpaceAllocator),__extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);i.prototype=e.prototype,t.prototype=new i},CoreComment=function(){function t(e,i){if("undefined"==typeof i&&(i={}),this.mode=1,this.stime=0,this.text="",this.ttl=settings.commentLifeTime,this.dur=settings.commentLifeTime,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!e)throw new Error("Comment not bound to comment manager.");if(this.parent=e,i.hasOwnProperty("stime")&&(this.stime=i.stime),this.mode=i.hasOwnProperty("mode")?i.mode:1,i.hasOwnProperty("dur")&&(this.dur=i.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,i.hasOwnProperty("text")&&(this.text=i.text),i.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=i.motion;for(var o=0,s=0;s<i.motion.length;s++){this._motionStart.push(o);var n=0;for(var r in i.motion[s]){var h=i.motion[s][r];n=Math.max(h.dur,n),(null===h.easing||void 0===h.easing)&&(i.motion[s][r].easing=t.LINEAR)}o+=n,this._motionEnd.push(o)}this._curMotion=0}i.hasOwnProperty("color")&&(this._color=i.color),i.hasOwnProperty("size")&&(this._size=i.size),i.hasOwnProperty("border")&&(this._border=i.border),i.hasOwnProperty("opacity")&&(this._alpha=i.opacity),i.hasOwnProperty("alpha")&&(this._alphaMotion=i.alpha),i.hasOwnProperty("font")&&(this._font=i.font),i.hasOwnProperty("x")&&(this._x=i.x),i.hasOwnProperty("y")&&(this._y=i.y),i.hasOwnProperty("shadow")&&(this._shadow=i.shadow),i.hasOwnProperty("position")&&"relative"===i.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){"undefined"==typeof t&&(t=null),this.dom=null!==t?t.dom:document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this._x=this.align%2===0?this.dom.offsetLeft:this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this._y=this.align<2?this.dom.offsetTop:this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var e=t.toString(16);e=e.length>=6?e:new Array(6-e.length+1).join("0")+e,this.dom.style.color="#"+e,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this.dom.style.border=this._border?"1px solid #00ffff":"none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this.dom.style.fontFamily=this._font.length>0?this._font:""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,e){for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];this[i]=o.easing(Math.min(Math.max(e-o.delay,0),o.dur),o.from,o.to-o.from,o.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),e=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],e),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,e,i,o){return t*i/o+e},t}(),ScrollComment=function(t){function e(e,i){t.call(this,e,i),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(e,t),Object.defineProperty(e.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),e.prototype.init=function(e){"undefined"==typeof e&&(e=null),t.prototype.init.call(this,e),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},e.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},e}(CoreComment),CommentManager=function(){function t(t){var e=0;this._listeners={},this.stage=t,this.options={global:{opacity:1,scale:1,className:"cmt"},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.startTimer=function(){if(!(e>0)){var t=(new Date).getTime(),i=this;e=window.setInterval(function(){var e=(new Date).getTime()-t;t=(new Date).getTime(),i.onTimerEvent(e,i)},10)}},this.stopTimer=function(){window.clearInterval(e),e=0}}var e=function(t,e){for(var i=Math.PI/180,o=t*i,s=e*i,n=Math.cos,r=Math.sin,h=[n(o)*n(s),n(o)*r(s),r(o),0,-r(s),n(s),0,0,-r(o)*n(s),-r(o)*r(s),n(o),0,0,0,0,1],a=0;a<h.length;a++)Math.abs(h[a])<1e-6&&(h[a]=0);return"matrix3d("+h.join(",")+")"};return t.prototype.stop=function(){this.stopTimer()},t.prototype.start=function(){this.startTimer()},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,e){return t<e.stime?-1:t>e.stime?1:0})},t.prototype.validate=function(t){return null==t?!1:this.filter.doValidate(t)},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0}),this.dispatchEvent("load")},t.prototype.insert=function(t){var e=BinArray.binsert(this.timeline,t,function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0});e<=this.position&&this.position++,this.dispatchEvent("insert")},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear")},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px"},t.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this.lastPos-t)>=2e3){if(this.seek(t),this.lastPos=t,this.timeline.length<=this.position)return}else this.lastPos=t;for(;this.position<this.timeline.length&&!(this.options.limit>0&&this.runline.length>this.limiter)&&(this.validate(this.timeline[this.position])&&this.timeline[this.position].stime<=t);this.position++)this.send(this.timeline[this.position])},t.prototype.rescale=function(){},t.prototype.send=function(t){if(8===t.mode)return console.log(t),void(this.scripting&&console.log(this.scripting.eval(t.code)));if(null==this.filter||(t=this.filter.doModify(t),null!=t)){if(1===t.mode||2===t.mode||6===t.mode)var i=new ScrollComment(this,t);else var i=new CoreComment(this,t);switch(i.mode){case 1:i.align=0;break;case 2:i.align=2;break;case 4:i.align=2;break;case 5:i.align=0;break;case 6:i.align=1}switch(i.init(),this.stage.appendChild(i.dom),i.mode){default:case 1:this.csa.scroll.add(i);break;case 2:this.csa.scrollbtm.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i);break;case 6:this.csa.reverse.add(i);break;case 17:case 7:(0!==t.rY||0!==t.rZ)&&(i.dom.style.transform=e(t.rY,t.rZ),i.dom.style.webkitTransform=e(t.rY,t.rZ),i.dom.style.OTransform=e(t.rY,t.rZ),i.dom.style.MozTransform=e(t.rY,t.rZ),i.dom.style.MSTransform=e(t.rY,t.rZ))}i.y=i.y,this.dispatchEvent("enterComment",i),this.runline.push(i)}},t.prototype.sendComment=function(t){console.log("CommentManager.sendComment is deprecated. Please use send instead"),this.send(t)},t.prototype.finish=function(t){this.dispatchEvent("exitComment",t),this.stage.removeChild(t.dom);var e=this.runline.indexOf(t);switch(e>=0&&this.runline.splice(e,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}},t.prototype.addEventListener=function(t,e){"undefined"!=typeof this._listeners[t]?this._listeners[t].push(e):this._listeners[t]=[e]},t.prototype.dispatchEvent=function(t,e){if("undefined"!=typeof this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)try{this._listeners[t][i](e)}catch(o){console.err(o.stack)}},t.prototype.onTimerEvent=function(t,e){for(var i=0;i<e.runline.length;i++){var o=e.runline[i];o.hold||o.time(t)}},t}();